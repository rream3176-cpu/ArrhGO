<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArhGo | لوحة التحليلات</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/arhgo.css">
  <script src="assets/js/arhgo.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      background: var(--bg-primary);
      padding-top: 80px;
      font-family: 'Cairo', sans-serif !important;
    }
    
    .analytics-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-xl) var(--spacing-lg);
    }
    
    .page-header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
    }
    
    .page-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
      font-family: 'Cairo', sans-serif;
    }
    
    .page-header p {
      font-size: 1rem;
      color: var(--text-secondary);
      font-family: 'Cairo', sans-serif;
    }
    
    .stats-section {
      margin-bottom: var(--spacing-xl);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
    }
    
    .stat-card {
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      background: linear-gradient(135deg, rgba(20, 27, 45, 0.8) 0%, rgba(15, 22, 36, 0.9) 100%);
      backdrop-filter: blur(30px) saturate(200%);
      -webkit-backdrop-filter: blur(30px) saturate(200%);
      border: 1px solid rgba(0, 229, 255, 0.2);
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(0, 229, 255, 0.1),
        inset 0 1px 1px rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      border-color: rgba(0, 229, 255, 0.4);
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
      font-family: 'Cairo', sans-serif;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
      font-family: 'Cairo', sans-serif;
    }
    
    .charts-section {
      margin-bottom: var(--spacing-xl);
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: var(--spacing-lg);
    }
    
    .chart-card {
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      background: linear-gradient(135deg, rgba(20, 27, 45, 0.8) 0%, rgba(15, 22, 36, 0.9) 100%);
      backdrop-filter: blur(30px) saturate(200%);
      -webkit-backdrop-filter: blur(30px) saturate(200%);
      border: 1px solid rgba(0, 229, 255, 0.2);
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(0, 229, 255, 0.1),
        inset 0 1px 1px rgba(255, 255, 255, 0.1);
    }
    
    .chart-card h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      font-family: 'Cairo', sans-serif;
    }
    
    .chart-container {
      position: relative;
      height: 250px;
    }
    
    .table-section {
      margin-bottom: var(--spacing-xl);
    }
    
    .table-card {
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      background: linear-gradient(135deg, rgba(20, 27, 45, 0.8) 0%, rgba(15, 22, 36, 0.9) 100%);
      backdrop-filter: blur(30px) saturate(200%);
      -webkit-backdrop-filter: blur(30px) saturate(200%);
      border: 1px solid rgba(0, 229, 255, 0.2);
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(0, 229, 255, 0.1),
        inset 0 1px 1px rgba(255, 255, 255, 0.1);
    }
    
    .table-card h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      font-family: 'Cairo', sans-serif;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid rgba(0, 229, 255, 0.1);
      font-family: 'Cairo', sans-serif;
    }
    
    .data-table th {
      background: rgba(0, 229, 255, 0.08);
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .data-table td {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .data-table tr:hover {
      background: rgba(0, 229, 255, 0.05);
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-lg);
      flex-wrap: wrap;
    }
    
    .actions .btn {
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
    }
    
    .empty-state {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
      font-family: 'Cairo', sans-serif;
    }
    
    @media (max-width: 768px) {
      .analytics-container {
        padding: var(--spacing-md);
      }
      
      .page-header h1 {
        font-size: 1.5rem;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--spacing-sm);
      }
      
      .stat-card {
        padding: var(--spacing-md);
      }
      
      .stat-value {
        font-size: 1.5rem;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        height: 220px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body class="page-hidden">
  <nav class="arhgo-nav">
    <div class="arhgo-logo">ArhGo</div>
    <ul>
      <li><a data-nav href="index.html">الرئيسية</a></li>
      <li><a data-nav href="smart-planner.html">مولد خطط</a></li>
      <li><a data-nav href="budget-manager.html">إدارة الميزانية</a></li>
      <li><a data-nav href="price-comparison.html">مقارنة الأسعار</a></li>
      <li><a data-nav href="smart-alerts.html">التنبيهات</a></li>
    </ul>
  </nav>

  <main class="analytics-container">
    <div class="page-header">
      <h1>لوحة التحليلات</h1>
      <p>إحصائيات وتحليلات شاملة لرحلاتك</p>
    </div>

    <section class="stats-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalTrips">0</div>
          <div class="stat-label">إجمالي الرحلات</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value" id="totalDestinations">0</div>
          <div class="stat-label">الوجهات المزورة</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value" id="totalSpent">$0</div>
          <div class="stat-label">إجمالي المصروفات</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value" id="avgRating">0.0</div>
          <div class="stat-label">متوسط التقييم</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value" id="totalDays">0</div>
          <div class="stat-label">إجمالي أيام السفر</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value" id="savedPlans">0</div>
          <div class="stat-label">الخطط المحفوظة</div>
        </div>
      </div>
    </section>

    <section class="charts-section">
      <div class="charts-grid">
        <div class="chart-card">
          <h3>توزيع الرحلات حسب الوجهات</h3>
          <div class="chart-container">
            <canvas id="destinationsChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <h3>المصروفات الشهرية</h3>
          <div class="chart-container">
            <canvas id="expensesChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <h3>اتجاهات السفر</h3>
          <div class="chart-container">
            <canvas id="trendsChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <h3>أنواع الرحلات</h3>
          <div class="chart-container">
            <canvas id="tripTypesChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="table-section">
      <div class="table-card">
        <h3>تفاصيل الرحلات الأخيرة</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>الوجهة</th>
              <th>عدد الأيام</th>
              <th>التكلفة</th>
              <th>النوع</th>
              <th>التاريخ</th>
              <th>التقييم</th>
            </tr>
          </thead>
          <tbody id="tripsTableBody">
            <!-- سيتم ملؤها بالبيانات -->
          </tbody>
        </table>
        
        <div class="actions">
          <button class="btn btn-gradient" onclick="exportToPDF()">تصدير PDF</button>
          <button class="btn btn-ghost" onclick="exportToExcel()">تصدير Excel</button>
          <button class="btn btn-ghost" onclick="refreshAnalytics()">تحديث البيانات</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    function getAnalyticsData() {
      const plans = JSON.parse(localStorage.getItem('arhgo-plans') || '[]');
      const trips = plans.map(plan => ({
        destination: plan.country || 'غير محدد',
        days: plan.days || 0,
        cost: plan.estimatedCost || 0,
        type: plan.tripType || 'غير محدد',
        date: new Date(plan.createdAt || Date.now()).toLocaleDateString('ar'),
        rating: (Math.random() * 2 + 3).toFixed(1)
      }));
      
      return {
        trips,
        totalTrips: trips.length,
        totalDestinations: new Set(trips.map(t => t.destination)).size,
        totalSpent: trips.reduce((sum, t) => sum + (t.cost || 0), 0),
        totalDays: trips.reduce((sum, t) => sum + (t.days || 0), 0),
        avgRating: trips.length > 0 ? (trips.reduce((sum, t) => sum + parseFloat(t.rating), 0) / trips.length).toFixed(1) : 0,
        savedPlans: plans.length
      };
    }

    function updateStats() {
      const data = getAnalyticsData();
      
      animateValue('totalTrips', 0, data.totalTrips, 1000);
      animateValue('totalDestinations', 0, data.totalDestinations, 1000);
      animateValue('totalSpent', 0, data.totalSpent, 1500, '$');
      animateValue('totalDays', 0, data.totalDays, 1000);
      animateValue('avgRating', 0, parseFloat(data.avgRating), 1000, '', 1);
      animateValue('savedPlans', 0, data.savedPlans, 1000);
    }

    function animateValue(id, start, end, duration, prefix = '', decimals = 0) {
      const element = document.getElementById(id);
      if (!element) return;
      
      const range = end - start;
      const increment = range / (duration / 16);
      let current = start;
      
      const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
          current = end;
          clearInterval(timer);
        }
        element.textContent = prefix + current.toFixed(decimals);
      }, 16);
    }

    function drawCharts() {
      const data = getAnalyticsData();
      
      if (data.trips.length === 0) {
        return;
      }
      
      const destinations = {};
      data.trips.forEach(trip => {
        const dest = trip.destination || 'غير محدد';
        destinations[dest] = (destinations[dest] || 0) + 1;
      });
      
      const destinationsCtx = document.getElementById('destinationsChart');
      if (destinationsCtx) {
        new Chart(destinationsCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(destinations),
            datasets: [{
              data: Object.values(destinations),
              backgroundColor: [
                'rgba(0, 229, 255, 0.8)',
                'rgba(0, 207, 200, 0.8)',
                'rgba(142, 162, 182, 0.8)',
                'rgba(201, 178, 122, 0.8)',
                'rgba(16, 185, 129, 0.8)'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                position: 'bottom',
                labels: { color: 'rgba(255, 255, 255, 0.8)', font: { family: 'Cairo' } }
              }
            }
          }
        });
      }
      
      const monthlyExpenses = {};
      data.trips.forEach(trip => {
        try {
          const month = new Date(trip.date).toLocaleDateString('ar', { month: 'long', year: 'numeric' });
          monthlyExpenses[month] = (monthlyExpenses[month] || 0) + (trip.cost || 0);
        } catch (e) {
          const month = 'غير محدد';
          monthlyExpenses[month] = (monthlyExpenses[month] || 0) + (trip.cost || 0);
        }
      });
      
      const expensesCtx = document.getElementById('expensesChart');
      if (expensesCtx) {
        new Chart(expensesCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(monthlyExpenses),
            datasets: [{
              label: 'المصروفات ($)',
              data: Object.values(monthlyExpenses),
              backgroundColor: 'rgba(0, 229, 255, 0.6)',
              borderColor: 'rgba(0, 229, 255, 1)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { 
                beginAtZero: true,
                ticks: { color: 'rgba(255, 255, 255, 0.8)', font: { family: 'Cairo' } },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: 'rgba(255, 255, 255, 0.8)', font: { family: 'Cairo' } },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
      }
      
      const trends = {};
      data.trips.forEach(trip => {
        try {
          const month = new Date(trip.date).toLocaleDateString('ar', { month: 'short' });
          trends[month] = (trends[month] || 0) + 1;
        } catch (e) {
          const month = 'غير محدد';
          trends[month] = (trends[month] || 0) + 1;
        }
      });
      
      const trendsCtx = document.getElementById('trendsChart');
      if (trendsCtx) {
        new Chart(trendsCtx, {
          type: 'line',
          data: {
            labels: Object.keys(trends),
            datasets: [{
              label: 'عدد الرحلات',
              data: Object.values(trends),
              borderColor: 'rgba(0, 229, 255, 1)',
              backgroundColor: 'rgba(0, 229, 255, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { 
                beginAtZero: true,
                ticks: { color: 'rgba(255, 255, 255, 0.8)', font: { family: 'Cairo' } },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: 'rgba(255, 255, 255, 0.8)', font: { family: 'Cairo' } },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
      }
      
      const tripTypes = {};
      data.trips.forEach(trip => {
        const type = trip.type || 'غير محدد';
        tripTypes[type] = (tripTypes[type] || 0) + 1;
      });
      
      const tripTypesCtx = document.getElementById('tripTypesChart');
      if (tripTypesCtx) {
        new Chart(tripTypesCtx, {
          type: 'pie',
          data: {
            labels: Object.keys(tripTypes),
            datasets: [{
              data: Object.values(tripTypes),
              backgroundColor: [
                'rgba(0, 229, 255, 0.8)',
                'rgba(0, 207, 200, 0.8)',
                'rgba(142, 162, 182, 0.8)',
                'rgba(201, 178, 122, 0.8)',
                'rgba(16, 185, 129, 0.8)'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                position: 'bottom',
                labels: { color: 'rgba(255, 255, 255, 0.8)', font: { family: 'Cairo' } }
              }
            }
          }
        });
      }
    }

    function updateTable() {
      const data = getAnalyticsData();
      const tbody = document.getElementById('tripsTableBody');
      
      if (!tbody) return;
      
      if (data.trips.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">لا توجد رحلات بعد. ابدأ بإنشاء خطة جديدة!</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.trips.slice(0, 10).map(trip => `
        <tr>
          <td><strong>${trip.destination}</strong></td>
          <td>${trip.days} يوم</td>
          <td>$${trip.cost}</td>
          <td>${trip.type}</td>
          <td>${trip.date}</td>
          <td>${trip.rating}</td>
        </tr>
      `).join('');
    }

    function exportToPDF() {
      alert('سيتم إضافة ميزة تصدير PDF قريباً!');
    }

    function exportToExcel() {
      const data = getAnalyticsData();
      let csv = 'الوجهة,عدد الأيام,التكلفة,النوع,التاريخ,التقييم\n';
      data.trips.forEach(trip => {
        csv += `${trip.destination},${trip.days},${trip.cost},${trip.type},${trip.date},${trip.rating}\n`;
      });
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `arhgo-analytics-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function refreshAnalytics() {
      updateStats();
      drawCharts();
      updateTable();
    }

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        updateStats();
        drawCharts();
        updateTable();
      }, 500);
    });
  </script>
</body>
</html>
